<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>TSLint performance tips</title>
    <meta name="description" content="TSLint documentation. A linter for the TypeScript language.
">

    <link rel="stylesheet" href="/tslint/css/main.css">
    <link rel="canonical" href="http://localhost:4000/tslint/develop/custom-rules/performance-tips">
</head>


  <body>

    

<header class="header">
  <section class="site-header">
      <a class="site-title" href="/tslint/">TSLint</a>
      <nav class="site-nav">
        <a class="page-link" href="/tslint/usage/cli">Usage</a>
        <a class="page-link" href="/tslint/rules">Rules</a>
        <a class="page-link" href="/tslint/formatters">Formatters</a>
        <a class="page-link" href="/tslint/develop/custom-rules">Develop</a>
        <a class="page-link" href="/tslint/news">News</a>
      </nav>
  </section>
  
</header>


    <div class="main-content">
        <div class="page">
   <article class="page-content">
      
      <header class="post-header">
         <h1 class="post-title">TSLint performance tips</h1>
         <p></p>
      </header>
      

      <p>As TSLint has matured, we have developed some best practices for making rules run faster. TSLint 5.0 was a particularly
significant release that featured many performance enhancements using the below tips (some codebases experienced lint times
cut in half).</p>

<h3 id="use-the-typechecker-only-when-needed">Use the TypeChecker only when needed</h3>

<p>The TypeChecker is a really mighty tool, but that comes with a cost. To create a TypeChecker the Program first has to locate, read, parse and bind all SourceFiles referenced.
To avoid that cost, try to avoid the TypeChecker where possible.</p>

<p>If you are interested in the JSDoc of a function for example, you <em>could</em> ask the TypeChecker.
But there’s another way: call <code class="highlighter-rouge">.getChildren()</code> on the FunctionDeclaration and search for nodes of kind <code class="highlighter-rouge">ts.SyntaxKind.JSDocComment</code>.
Those nodes will precede other nodes in the array.</p>

<h3 id="avoid-walking-the-ast-if-possible">Avoid walking the AST if possible</h3>

<p>Some rules work directly on the content of the source file.</p>

<p>For example, <code class="highlighter-rouge">max-file-line-count</code> and <code class="highlighter-rouge">linebreak-style</code> don’t need to walk the AST at all.</p>

<p>Other rules define exceptions: <code class="highlighter-rouge">no-consecutive-blank-lines</code> ignores template strings.
To optimize for the best case, this rule can first look for failures in the source.
If and only if there are any failures, walk the AST to find the location of all template strings to filter the failures.</p>

<h3 id="implement-your-own-walking-algorithm">Implement your own walking algorithm</h3>

<p>Convenience comes with a price. When using <code class="highlighter-rouge">SyntaxWalker</code> or any subclass thereof like <code class="highlighter-rouge">RuleWalker</code> you pay the price for the
big switch statement in <code class="highlighter-rouge">visitNode</code> which then calls the appropriate <code class="highlighter-rouge">visitXXX</code> method for <strong>every</strong> node in the AST, even if you don’t use them.</p>

<p>Use <code class="highlighter-rouge">AbstractWalker</code> instead and implement the <code class="highlighter-rouge">walk</code> method to fit the needs of your rule.
It’s as simple as this:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">MyWalker</span> <span class="kd">extends</span> <span class="nx">Lint</span><span class="p">.</span><span class="nx">AbstractWalker</span><span class="o">&lt;</span><span class="nx">MyOptionsType</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kr">public</span> <span class="nx">walk</span><span class="p">(</span><span class="na">sourceFile</span><span class="p">:</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">SourceFile</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">cb</span> <span class="o">=</span> <span class="p">(</span><span class="na">node</span><span class="p">:</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">Node</span><span class="p">):</span> <span class="k">void</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">someCondition</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// do stuff</span>
            <span class="p">}</span>
            <span class="c1">// Wondering why return is used below? Refer to "Make use of tail calls"</span>
            <span class="k">return</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">forEachChild</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span> <span class="c1">// recurse deeper</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">forEachChild</span><span class="p">(</span><span class="nx">sourceFile</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span> <span class="c1">// start recursion with children of sourceFile</span>
    <span class="p">}</span>
</code></pre></div></div>

<h3 id="dont-walk-the-whole-ast-if-possible">Don’t walk the whole AST if possible</h3>

<p><strong>The language specification is your friend</strong>:
The language spec defines where each statement can occur.
For example, if you are interested in <code class="highlighter-rouge">import</code> statements, you only need to search in <code class="highlighter-rouge">sourceFile.statements</code> and nested <code class="highlighter-rouge">NamespaceDeclaration</code>s.</p>

<p><strong>Don’t visit AST branches you’re not interested in</strong>:
For example, <code class="highlighter-rouge">no-null-keyword</code> creates no failure if the null keyword is part of another type.
There are two ways to achieve this:</p>

<ul>
  <li>Recurse into the AST until you find a token of kind NullKeyword and then walk up its parent chain to find out if it is part of a type node.</li>
  <li>Stop recursing deeper into that branch as soon as you hit a type node (preferred).</li>
</ul>

<h3 id="avoid-frequently-creating-one-time-closures-in-the-hot-path">Avoid frequently creating one-time closures in the hot path</h3>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">SomeClass</span> <span class="p">{</span>
    <span class="c1">// this is a simplified version of what SyntaxWalker does under the hood</span>
    <span class="nx">doStuff</span><span class="p">(</span><span class="nx">node</span><span class="p">:</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">Node</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// do stuff ...</span>

        <span class="nx">ts</span><span class="p">.</span><span class="nx">forEachChild</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">doStuff</span><span class="p">(</span><span class="nx">n</span><span class="p">));</span>
                           <span class="c1">// ~~~~~~~~~~~~~~~~~~~~~~ [a new closure is created for EVERY node in the AST and remains on the call stack</span>
                           <span class="c1">//                         until processing of all children is done]</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Instead use the same closure for every call like the example above in <strong>Implement your own walking algorithm</strong>.</p>

<h3 id="create-small-specialized-functions--methods">Create small specialized functions / methods</h3>

<p>Instead of stuffing the whole logic in a single closure, consider splitting it up into smaller functions or methods.
Each function should handle similar kinds of nodes. Don’t worry too much about the function call, since V8 eventually inlines the function
if possible.</p>

<p>The AST nodes have different properties, therefore they have a different hidden class in V8. A function can only be optimized for a certain
amount of different hidden classes. Above that threshold the function will be deoptimized and is never optimized again.</p>

<h3 id="supply-the-optional-sourcefile-parameter">Supply the optional sourceFile parameter</h3>

<p>There are serveral methods that have an optional parameter <code class="highlighter-rouge">sourceFile</code>. Don’t omit this parameter if you care for performance.
If ommitted, typescript needs to walk up the node’s parent chain until it reaches the SourceFile. This <em>can</em> be quite costly when done
frequently on deeply nested nodes.</p>

<p>Some examples:</p>

<ul>
  <li><code class="highlighter-rouge">node.getStart()</code></li>
  <li><code class="highlighter-rouge">node.getWidth()</code></li>
  <li><code class="highlighter-rouge">node.getText()</code></li>
  <li><code class="highlighter-rouge">node.getChildren()</code></li>
  <li><code class="highlighter-rouge">node.getFirstToken()</code></li>
  <li><code class="highlighter-rouge">node.getLeadingTriviaWidth()</code></li>
</ul>

<h3 id="avoid-excessive-calls-to-nodegetstart-nodegetwidth-and-nodegettext">Avoid excessive calls to node.getStart(), node.getWidth() and node.getText()</h3>

<p><code class="highlighter-rouge">node.getStart()</code> scans the source to skip all the leading trivia. Although barely noticeable, this operation is not for free.
If you need the start position of a node more than once per function, consider caching it.</p>

<p><code class="highlighter-rouge">node.getWidth()</code> is most of the time used together with <code class="highlighter-rouge">node.getStart()</code> to get the node’s span. Internally it uses <code class="highlighter-rouge">node.getEnd() - node.getStart()</code> which effectively doubles the calls to <code class="highlighter-rouge">node.getStart()</code>. Consider using <code class="highlighter-rouge">node.getEnd()</code> instead and calculate the width yourself if necessary.</p>

<p><code class="highlighter-rouge">node.getText()</code> calculates the start of the node and returns a substring until the end of the token.
Most of the time this not needed, because this substring is already contained in the node.</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">declare</span> <span class="nx">node</span><span class="p">:</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">Identifier</span><span class="p">;</span>
<span class="nx">node</span><span class="p">.</span><span class="nx">getText</span><span class="p">()</span> <span class="o">===</span> <span class="nx">node</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span> <span class="c1">// prefer node.text where available</span>
</code></pre></div></div>

<p><strong>Bonus points:</strong> If you know the width of the node (either from the <code class="highlighter-rouge">text</code> property or because it is a keyword of known width),
you can use <code class="highlighter-rouge">node.getEnd() - width</code> to calculate the node’s start.
<code class="highlighter-rouge">node.getEnd()</code> is effectively for free as it only returns the <code class="highlighter-rouge">end</code> property. This way you avoid the cost of skipping leading trivia.</p>

<h3 id="make-use-of-tail-calls">Make use of tail calls</h3>

<p>Tail calls are function or method calls at the end of the control flow of a function. It’s only a tail call if the return value of that call
is directly returned unchanged. Browsers can optimize this pattern for performance.
Further optimization is specced in ES2015 as “Proper Tail Calls”.
With proper tail calls the browser reuses the stack frame of the current function. When done right this allows for infinite recursion.</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">condition</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">bar</span><span class="p">();</span> <span class="c1">// tail call</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">someOtherCondition</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">foo</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// no tail call, return value is modified</span>
    <span class="k">return</span> <span class="nx">baz</span><span class="p">();</span> <span class="c1">// tail call</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">bas</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cond</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">someGlobalVariable</span> <span class="o">=</span> <span class="nx">bar</span><span class="p">();</span> <span class="c1">// no tail call, return value is stored in value before it is returned</span>
    <span class="nx">foo</span><span class="p">();</span> <span class="c1">// no tail call because there is no return</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="typeguards">Typeguards</h3>

<p>Typeguard functions are very small by default. These functions will be inlined into the containing function.
After inlining you no longer pay the cost of the function call.</p>

<p>But beware of the inlining limit. If a function is big enough or already has many inlined functions, V8 will stop inlining other functions.</p>

<p>Try to use a discriminated union if possible. A typeguard makes sense if you can save up multiple type assertions.</p>

   </article>
   <section class="page-sidebar">
      

      
      

      
      

      
         
<h4 class="sidebar-title">Develop</h4>
<ul class="sidebar-links">
   
      
      
      <li><h6 class=""><a href="/tslint/develop/custom-rules/">Custom Rules</a></h6></li>
   
      
      
      <li><h6 class=""><a href="/tslint/develop/custom-rules/performance-tips.html">Performance Tips</a></h6></li>
   
      
      
      <li><h6 class=""><a href="/tslint/develop/custom-rules/walker-design.html">Walker Design</a></h6></li>
   
      
      
      <li><h6 class=""><a href="/tslint/develop/custom-formatters/">Custom Formatters</a></h6></li>
   
      
      
      <li><h6 class=""><a href="/tslint/develop/contributing/">Contributing</a></h6></li>
   
      
      
      <li><h6 class=""><a href="/tslint/develop/docs/">Docs Development</a></h6></li>
   
      
      
      <li><h6 class=""><a href="/tslint/develop/testing-rules">Testing Rules</a></h6></li>
   
</ul>

      
   </section>

</div>

        <footer class="site-footer">
  <div class="footer-col-wrapper">
    <div class="footer-col  footer-col-1">
      <ul class="contact-list">
        <li>©2016 Palantir Technologies under <a href="https://github.com/palantir/tslint/blob/master/LICENSE">Apache 2.0</a></li>
        <li>Styles based off of the <a href="https://github.com/jasonlong/cayman-theme">Cayman Theme</a> by Jason Long.
        <li>Issues? <a href="https://github.com/palantir/tslint">Let us know on GitHub.</a></li>
      </ul>
    </div>

    <div class="footer-col  footer-col-2">
      <ul class="social-media-list">
        
        <li>
          <a href="https://github.com/palantir/tslint">
            <span class="icon  icon--github">
              <svg viewBox="0 0 16 16">
                <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>

            <span class="username">palantir/tslint</span>
          </a>
        </li>
        

        
        <li>
          <a href="https://twitter.com/PalantirTech">
            <span class="icon  icon--twitter">
              <svg viewBox="0 0 16 16">
                <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>

            <span class="username">PalantirTech</span>
          </a>
        </li>
        
      </ul>
    </div>
  </div>
</footer>

    </div>

  </body>

</html>
